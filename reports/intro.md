# Ml inference in trustzone with tvm

## Background
画像など任意の次元のデータを入力としてその特徴量を学習し、それをもとにデータのより抽象的な特徴を推論する機械学習はその広範な利用可能性から様々な産業によって応用される段階まで来ている。当然その中にはプライバシーを重視するような顧客がいたり、学習したモデルの金銭的な利益を守りたい企業がいたりする。したがってモデルの学習時及び推論時に入力データやモデルデータの秘匿性を保証したいという要求が高まっている。この秘匿化したまま情報を処理するという技術は"Confidential Computing"、または"秘密計算"などという名前がつけられている。

#### 3 way of Confidential Computing
主に３つの手法が挙げられる。
* 完全準同型暗号(Homomorphic Encryption)
    * 暗号文のまま加法や乗法を行える暗号技術
    * 暗号技術のみで実現できる
    * まだ実用的な処理速度に達していない
* TEE(Trusted Execution)
    * ハードウェアベンダによって提供される隔離実行環境
    * 処理速度が比較的速い
    * ベンダによって実装が異なる、サイドチャネル脆弱性やバグによって突破される可能性がある
* MPC(Multi Party Computation)
    * １つのデータを参加者それぞれに分散し、その後計算結果を復元できるようなアルゴリズム
    * 処理速度が比較的速い、並列計算が容易
    * 複数の参加者、多くの通信を必要とする

ここではさらにTEEについてより深く見ていく。

#### Trusted Execution Environment
前述の通りハードウェアベンダによって実装が異なる。
ここではすべてを説明することは割愛するが、IntelやAMDの実装は主にサーバーでの利用者を、Armの実装は主にスマホやIoTなどでの利用を想定している。  

ArmによるTEEの実装、TrustZoneは起動時よりリソースをSecure/Non-Secureに分割することで実現されている。
以下の図のようにLinux,U-Bootなどの利用する部分をNormal World,それ以外のファームウェアや独自に実装されたTrusted OSをSecure Worldとして分割し、Secure World内でメモリやペリフェラルのコントローラーの設定が管理される。
そうすることで例えば特定のアドレス範囲にはNon-SecureなAccessが禁止されるようになり、データを保護できる。
また、２つのやりとりには特定のAPI仕様(GlobalPlatform API)が定められており、カーネルドライバーとTrusted OSがAPI関数内でファームウェアを介して通信することになっている。

![](https://i.imgur.com/CUdzLAU.png)

## Abstract
学習済みDNNモデルの推論をTrusted Execution Environment内で行うことで、モデルデータを配布された利用者に対して秘匿化することを目的とした実験を行うことを目指した。モデルの生成にはチューニングの可能なDNNコンパイラのTVMを、TEEにはTrustZoneを、Trusted OSにはOPTEEを利用した。

## OverView
今回の実験を行うためには、
* コンパイルされたモデル情報、
* Trusted OS上で動作する推論ランタイム、
* 入力や初期化を支持するClient-side application

が必要となる。

またTVMに限って言うとモデルの情報は
* 計算を行うライブラリ、
* それらを構造化するグラフ情報、
* モデルの行列のパラメータを保存するバイナリ

の３つに分けて出力されるため、Linuxから動的にモデルを入れ替えるためにはこの３つをTrusted Sideに送る必要がある。

## Obstacles
当然だが、TVMやTrustZoneを利用するためにはある程度内部動作を理解する必要があるため、ドキュメントをよく読む必要がある。

また、OPTEE上でプログラムを動作させるまでにいくつかの障害があった。
* C++がサポートされていないため多くの推論ランタイムを候補に入れづらくなっている。
* OPTEEが提供するrootfs(Buildroot)は機能が絞られているため、開発にはrootfsを入れ替える必要がある。

## Results
Desktop PC及びRaspberry PiのLinux sideでTVMランタイムによる推論の動作を確認した。
１回の推論計算にDesktop PCでは約２秒、Raspberry Pi上では約６０秒かかった。

## Future Task
* TrustZone上で動作を確認する。
* なぜ実行結果が良くないのか原因を探る。
    * TVMの最適化を行えておらず、コンパイラの最適化を行っていないため、それらの調整を試す。
* ３つのモデルを構成する情報のうちライブラリについては静的リンクを必要とするために直接Trusted Appにリンクさせているがそれを動的に組み込めるようにする。
* Raspberry PiにはDRAMやペリフェラルを制限するコントローラーが実装されていないため他の実装されているボードを利用する。
* メモリ分割に制限があるのか、それとも設定によって十分に拡張可能なのか検証する


